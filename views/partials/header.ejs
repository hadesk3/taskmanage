<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- Favicon -->
        <link rel="shortcut icon" href="/images/favicon.ico" />
        <link rel="stylesheet" href="/css/backend-plugin.min.css" />
        <link rel="stylesheet" href="/css/backend.css?v=1.0.0" />
        <link
            rel="stylesheet"
            href="/vendor/line-awesome/dist/line-awesome/css/line-awesome.min.css"
        />
        <link rel="stylesheet" href="/vendor/remixicon/fonts/remixicon.css" />

        <link
            rel="stylesheet"
            href="/vendor/tui-calendar/tui-calendar/dist/tui-calendar.css"
        />
        <link
            rel="stylesheet"
            href="/vendor/tui-calendar/tui-date-picker/dist/tui-date-picker.css"
        />
        <link
            rel="stylesheet"
            href="/vendor/tui-calendar/tui-time-picker/dist/tui-time-picker.css"
        />
    </head>
    <body>
        <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>

        <div class="iq-top-navbar">
            <div class="iq-navbar-custom">
                <nav class="navbar navbar-expand-lg navbar-light p-0">
                    <div
                        class="iq-navbar-logo d-flex align-items-center justify-content-between"
                    >
                        <i class="ri-menu-line wrapper-menu"></i>
                        <a href="/" class="header-logo">
                            <h4 class="logo-title text-uppercase">Webkit</h4>
                        </a>
                    </div>
                    <div class="navbar-breadcrumb">
                        <h5>Dashboard</h5>
                    </div>
                    <div class="d-flex align-items-center">
                        <button
                            class="navbar-toggler"
                            type="button"
                            data-toggle="collapse"
                            data-target="#navbarSupportedContent"
                            aria-controls="navbarSupportedContent"
                            aria-label="Toggle navigation"
                        >
                            <i class="ri-menu-3-line"></i>
                        </button>
                        <div
                            class="collapse navbar-collapse"
                            id="navbarSupportedContent"
                        >
                            <ul
                                class="navbar-nav ml-auto navbar-list align-items-center"
                            >
                                <li>
                                    <div class="iq-search-bar device-search">
                                        <form action="#" class="searchbox">
                                            <a class="search-link" href="#"
                                                ><i class="ri-search-line"></i
                                            ></a>
                                            <input
                                                type="text"
                                                class="text search-input"
                                                placeholder="Search here..."
                                            />
                                        </form>
                                    </div>
                                </li>
                                <li class="nav-item nav-icon search-content">
                                    <a
                                        href="#"
                                        class="search-toggle rounded"
                                        id="dropdownSearch"
                                        data-toggle="dropdown"
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                    >
                                        <i class="ri-search-line"></i>
                                    </a>
                                    <div
                                        class="iq-search-bar iq-sub-dropdown dropdown-menu"
                                        aria-labelledby="dropdownSearch"
                                    >
                                        <form action="#" class="searchbox p-2">
                                            <div
                                                class="form-group mb-0 position-relative"
                                            >
                                                <input
                                                    type="text"
                                                    class="text search-input font-size-12"
                                                    placeholder="type here to search..."
                                                />
                                                <a href="#" class="search-link"
                                                    ><i
                                                        class="las la-search"
                                                    ></i
                                                ></a>
                                            </div>
                                        </form>
                                    </div>
                                </li>

                                <li
                                    class="nav-item nav-icon nav-item-icon dropdown"
                                >
                                    <a
                                        href="#"
                                        class="search-toggle dropdown-toggle"
                                        id="dropdownMenuButton"
                                        data-toggle="dropdown"
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            class="feather feather-bell"
                                        >
                                            <path
                                                d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"
                                            ></path>
                                            <path
                                                d="M13.73 21a2 2 0 0 1-3.46 0"
                                            ></path>
                                        </svg>
                                        <span class="bg-primary"></span>
                                    </a>
                                    <div
                                        class="iq-sub-dropdown dropdown-menu"
                                        aria-labelledby="dropdownMenuButton"
                                    >
                                        <div class="card shadow-none m-0">
                                            <div class="card-body p-0">
                                                <div class="cust-title p-3">
                                                    <div
                                                        class="d-flex align-items-center justify-content-between"
                                                    >
                                                        <h5 class="mb-0">
                                                            Notifications
                                                        </h5>
                                                        <a
                                                            class="badge badge-primary badge-card"
                                                            href="#"
                                                            id="notificationCount"
                                                            >0</a
                                                        >
                                                    </div>
                                                </div>
                                                <div
                                                    class="px-3 pt-0 pb-0 sub-card"
                                                    id="notificationList"
                                                ></div>
                                                <a
                                                    class="right-ic btn btn-primary btn-block position-relative p-2"
                                                    href="/notification"
                                                    role="button"
                                                >
                                                    View All
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li
                                    class="nav-item nav-icon dropdown caption-content"
                                >
                                    <a
                                        href="#"
                                        class="search-toggle dropdown-toggle d-flex align-items-center"
                                        id="dropdownMenuButton4"
                                        data-toggle="dropdown"
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                    >
                                        <img
                                            src="/images/user/1.jpg"
                                            class="img-fluid rounded-circle"
                                            alt="user"
                                        />
                                        <div class="caption ml-3">
                                            <h6 class="mb-0 line-height">
                                                <%- user.name %><i
                                                    class="las la-angle-down ml-2"
                                                ></i>
                                            </h6>
                                        </div>
                                    </a>
                                    <ul
                                        class="dropdown-menu dropdown-menu-right border-none"
                                        aria-labelledby="dropdownMenuButton"
                                    >
                                        <li
                                            class="dropdown-item d-flex svg-icon"
                                        >
                                            <svg
                                                class="svg-icon mr-0 text-primary"
                                                id="h-01-p"
                                                width="20"
                                                xmlns="http://www.w3.org/2000/svg"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                                />
                                            </svg>
                                            <a href="/user-profile"
                                                >My Profile</a
                                            >
                                        </li>
                                        <li
                                            class="dropdown-item d-flex svg-icon"
                                        >
                                            <svg
                                                class="svg-icon mr-0 text-primary"
                                                id="h-02-p"
                                                width="20"
                                                xmlns="http://www.w3.org/2000/svg"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                                />
                                            </svg>
                                            <a href="/edit-profile"
                                                >Edit Profile</a
                                            >
                                        </li>

                                        <li
                                            class="dropdown-item d-flex svg-icon border-top"
                                        >
                                            <svg
                                                class="svg-icon mr-0 text-primary"
                                                id="h-05-p"
                                                width="20"
                                                xmlns="http://www.w3.org/2000/svg"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                                                />
                                            </svg>
                                            <a href="/auth/logout">Logout</a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </body>
</html>
<script>
    const socket = io("http://localhost:3000");

    const userData = <%- JSON.stringify(user) %>;

    socket.emit("register-user", userData._id);

    // Khi nhận được thông báo từ server qua socket
    socket.on("receiveNotification", (notification) => {
        // Gọi hàm renderNotifications để hiển thị thông báo ngay lập tức
        renderNotifications([notification], true); // true để thêm thông báo mới vào đầu danh sách
    });

    // Hàm tải thông báo từ API
    function loadNotifications() {
        fetch(`http://localhost:3000/api/notifications/${userData._id}`)
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    renderNotifications(data.notifications);
                }
            })
            .catch((error) =>
                console.error("Error loading notifications:", error)
            );
    }

    // Hàm hiển thị thông báo
    function renderNotifications(notifications, prepend = false) {
        const notificationList = document.getElementById("notificationList");
        const notificationCount = document.getElementById("notificationCount");

        notificationCount.innerText =
            parseInt(notificationCount.innerText) + notifications.length;

        notifications.forEach((noti) => {
            console.log(noti);
            let item = '';
            if (noti.alert_type === 'Extend') {
                item = `
                    <a href="${window.location.origin}/notification/${noti._id}" class="iq-sub-card">
                        <div class="media align-items-center cust-card py-3 border-bottom">
                            <div class="">
                                <img class="avatar-50 rounded-small" src="${noti.user.avatar || "/images/user/default-avatar.png"}" alt="User" />
                            </div>
                            <div class="media-body ml-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h6 class="mb-0">${
                                        "Extend time"
                                    }</h6>
                                    <small class="text-dark"><b>${new Date(noti.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</b></small>

                                </div>
                                <small class="mb-0">
                                    <b>Reason:</b> ${ noti.reason || "No reason provided" }<br>
                                    <b>New Deadline:</b> ${ new Date(noti.date_extend).toLocaleDateString() }<br>
                                    <b>Task:</b> ${ noti.task_id.title } <br>
                                </small>
                            </div>
                        </div>
                    </a>
                `;
            } else if (noti.alert_type === 'Assign') {
                item = `
                    <a href="${window.location.origin}/task/${noti.project_id._id}" class="iq-sub-card">
                        <div class="media align-items-center cust-card py-3 border-bottom">
                            <div class="">
                                <img class="avatar-50 rounded-small" src="${noti.user.avatar || "/images/user/default-avatar.png"}" alt="User" />
                            </div>
                            <div class="media-body ml-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h6 class="mb-0">${
                                        "Assign task"
                                    }</h6>
                                    <small class="text-dark"><b>${new Date(noti.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</b></small>

                                </div>
                                <small class="mb-0">
                                    <b>You have been assign to project:</b> ${ noti.project_id.name } <br>
                                </small>
                            </div>
                        </div>
                    </a>
                `;
            }
            if (prepend) {
                notificationList.insertAdjacentHTML("afterbegin", item); // Thêm vào đầu danh sách
            } else {
                notificationList.innerHTML += item; // Thêm vào cuối danh sách
            }
        });
    }

    // Gọi loadNotifications khi trang mở lại
    window.onload = () => {
        loadNotifications();
    };
</script>
